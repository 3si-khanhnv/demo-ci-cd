<table
  mat-table
  [dataSource]="dataSource"
  multiTemplateDataRows
  [class.no-data-found-table]="isNoDataMessage"
  [class.showColBorder]="showBorderCols"
>
  <ng-container *ngFor="let field of displayedFields; let col = index" [matColumnDef]="field.column">
    <ng-container *ngIf="field.column === 'select'">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style"></th>
      <td mat-cell *matCellDef="let row; let i = dataIndex">
        <mat-radio-group [value]="i">
          <mat-radio-button [checked]="i === selectedIndex" (change)="getRecord(row); selectedIndex = i"></mat-radio-button>
        </mat-radio-group>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column.match('^status')">
      <th mat-header-cell [ngStyle]="field.style"></th>
      <td mat-cell *matCellDef="let row; let i = dataIndex" [ngStyle]="field.style">
        <div [class.show-icon]="row.status === 'rejected' || row.status.otherIcon">
          <ng-container *ngIf="typeOfValue(row.status) === 'string'">
            <imo-badge size="small" [class]="'status-' + row.status.toLocaleLowerCase()">{{ row.status | translate }}</imo-badge>
          </ng-container>
          <ng-container *ngIf="typeOfValue(row.status) === 'object' && !isArrayValue(row.status)">
            <imo-badge
              size="small"
              [class]="'status-' + row.status.value.toLocaleLowerCase()"
              (clicked)="row.status.click ? row.status.click(i) : null"
              ><span class="svg-icon">
                <span class="badge-label" *ngIf="!row.status.isInnerHTMLLabel">{{
                  row.status.label ? (row.status.label | translate) : row.status.value
                }}</span>
                <span class="badge-label" *ngIf="row.status.isInnerHTMLLabel" [innerHTML]="row.status.label | translate"></span>

                <imo-svg-icon *ngIf="row.status.icon" [icon]="row.status.icon" [color]="row.status.color"></imo-svg-icon> </span
            ></imo-badge>

            <imo-svg-icon
              *ngIf="row.status.otherIcon"
              [icon]="row.status.otherIcon.icon"
              (click)="row.status.otherIcon.click ? row.status.otherIcon.click(i) : null"
            ></imo-svg-icon>
          </ng-container>
          <imo-svg-icon *ngIf="row.status === 'rejected'" [icon]="balloon.icon" (click)="onClickShowComment(row)"></imo-svg-icon>
        </div></td
    ></ng-container>

    <ng-container *ngIf="field.column === 'checkbox'">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style">{{ field.name | translate }}</th>
      <td mat-cell *matCellDef="let row; let i = dataIndex">
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="getRecord(row)"
          [checked]="row?.checked"
          (keyup)="onKeyup($event, i)"
          [disabled]="row?.isDisable"
        ></mat-checkbox>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column === 'selectableCheckbox'">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style">{{ field.name | translate }}</th>
      <td mat-cell *matCellDef="let row; let i = dataIndex">
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="getChangeCheckbox($event.checked, i)"
          [checked]="row[field.column]?.checked"
          (keyup)="onKeyup($event, i)"
          [disabled]="row[field.column]?.disabled"
        ></mat-checkbox>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column === 'SkipCheckbox'">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style">{{ field.name | translate }}</th>
      <td mat-cell *matCellDef="let row; let i = dataIndex">
        <mat-checkbox
          (click)="$event.stopPropagation()"
          (change)="getSkipRow(row, i)"
          [checked]="row.isSkippable"
          (keyup)="onKeyup($event, i)"
        ></mat-checkbox>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column.match('SelectField$')">
      <th mat-header-cell [ngStyle]="field.style"></th>
      <td mat-cell *matCellDef="let row; let i = dataIndex" class="cell-dropdown">
        <imo-select
          (click)="$event.stopPropagation()"
          [placeholder]="row[field.column].placeholder | translate"
          [selectedItem]="row[field.column].selectedItem"
          [items]="row[field.column].options"
          (selected)="onSelectedItem($event, row, field.column)"
          [disabled]="row[field.column].disabled"
          [isReadonly]="row[field.column].isReadonly"
        ></imo-select>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column.match('SelectOrSearchField$')">
      <th mat-header-cell [ngStyle]="field.style"></th>
      <td mat-cell *matCellDef="let row; let i = dataIndex" class="cell-dropdown">
        <imo-select
          (click)="$event.stopPropagation()"
          [placeholder]="row[field.column].placeholder | translate"
          [selectedItem]="row[field.column].selectedItem"
          [items]="row[field.column].options"
          (selected)="onSelectedItem($event, row, field.column)"
          [autoComplete]="true"
          [disabled]="row[field.column].disabled"
          [isReadonly]="row[field.column].isReadonly"
        ></imo-select>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column.match('CheckboxField$')">
      <th mat-header-cell [hidden]="headless" *matHeaderCellDef [ngStyle]="field.style" [class.input-checkbox-field]="field.checkAll">
        <ng-container *ngIf="field.checkAll; else templateNormalHeader">
          <mat-checkbox
            [checked]="isAllChecked(field.column.replace('CheckboxField', ''))"
            [indeterminate]="isSomeChecked(field.column.replace('CheckboxField', ''))"
            (click)="$event.stopPropagation()"
            (change)="onCheckedAll($event)"
          ></mat-checkbox>
        </ng-container>
        <ng-template #templateNormalHeader>{{ field.name | translate }}</ng-template>
      </th>
      <td mat-cell *matCellDef="let row; let i = dataIndex" align="center" [ngStyle]="field.style" class="input-checkbox-field">
        <mat-checkbox
          [ngClass]="row[field.column.replace('CheckboxField', 'IsReadWarning')] && 'error-option'"
          (click)="$event.stopPropagation()"
          (change)="callableFunction(field.column.replace('CheckboxField', 'CheckFn'), $event, i, row)"
          [checked]="row[field.column.replace('CheckboxField', '')]"
          [disabled]="row[field.column.replace('CheckboxField', 'Disabled')]"
          (keydown)="onKeyup($event, i)"
        >
          <imo-svg-icon
            *ngIf="row[field.column.replace('CheckboxField', 'Caution')]"
            [width]="24"
            [height]="24"
            [icon]="'statusWarning'"
            [text]="row[field.column.replace('CheckboxField', 'Caution')].message"
          ></imo-svg-icon>
        </mat-checkbox>
        <span *ngIf="row[field.column.replace('CheckboxField', 'IsReadWarning')]" class="warning-message" data-test="warning-message">
          {{ row[field.column.replace("CheckboxField", "WarningMessage")] }}
        </span>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column.match('NoteField$')">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style">{{ field.name | translate }}</th>
      <td mat-cell *matCellDef="let row; let i = dataIndex" [ngStyle]="field.style" class="note-field">
        <ng-container *ngIf="row[field.column.replace('NoteField', '')]?.iconStatus">
          <imo-svg-icon
            [icon]="row[field.column.replace('NoteField', '')].iconStatus"
            [text]="row[field.column.replace('NoteField', '')].message"
          ></imo-svg-icon>
        </ng-container>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column === 'action'">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style">{{ field.name }}</th>
      <td mat-cell *matCellDef="let row; let i = dataIndex" [ngStyle]="field.style">
        <imo-button class="action" (clicked)="onClickEditButton(row); $event.stopPropagation()" *ngIf="row.isEditable">
          {{ actionLabels.EDIT | translate }}</imo-button
        >

        <imo-button class="action" (clicked)="onClickEditButton(row); $event.stopPropagation()" *ngIf="row?.isReadOnly">
          {{ actionLabels.VIEW | translate }}</imo-button
        >

        <imo-button class="action" (clicked)="onClickDeleteButton(row, i); $event.stopPropagation()" *ngIf="row.isDeletable">{{
          actionLabels.DELETE | translate
        }}</imo-button>

        <imo-button class="action" (clicked)="onClickEditButton(row); $event.stopPropagation()" *ngIf="row.isSettings">
          {{ actionLabels.SETTING | translate }}</imo-button
        >

        <imo-button class="action" (clicked)="onClickReAssignButton(row); $event.stopPropagation()" *ngIf="row.isReAssignable">
          {{ actionLabels.RE_ASSIGN | translate }}</imo-button
        >
      </td>
    </ng-container>

    <ng-container *ngIf="field.column.match('InputField$')">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style">{{ field.name | translate }}</th>
      <td
        mat-cell
        *matCellDef="let element; let i = dataIndex"
        (keyup)="onInputFieldEnter($event, inputField)"
        (click)="$event.stopPropagation()"
      >
        <imo-form
          #inputField
          [labels]="element[field.column].label"
          [formControl]="element[field.column].control"
          [changeFieldColor]="element[field.column].changeFieldColor"
          (blur)="element[field.column].onBlur ? element[field.column].onBlur($event) : element.onBlur ? element.onBlur($event) : null"
          (afterViewInit)="element[field.column].afterViewInit ? element[field.column].afterViewInit() : null"
          imoTooltip
          [tooltip]="element[field.column].tooltip?.tooltip"
          [placement]="element[field.column].tooltip?.placement"
          [contentType]="element[field.column].tooltip?.contentType"
          [disabled]="element[field.column]?.disabled ?? false"
        ></imo-form>

        <imo-svg-icon
          *ngIf="element[field.column].status"
          [url]="element[field.column].status?.otherIcon.url"
          [color]="element[field.column].status?.color"
          [width]="element[field.column].status?.otherIcon.width"
          [height]="element[field.column].status?.otherIcon.height"
        ></imo-svg-icon>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column.match('TextStyle$')">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style">{{ field.name | translate }}</th>
      <td mat-cell *matCellDef="let element; let i = dataIndex">
        <div
          #blockElement
          [matTooltip]="element[field.column]"
          (mouseover)="isTextOverflow(blockElement, i)"
          [matTooltipDisabled]="!tooltips[i]"
          matTooltipClass="large-tooltip"
          [ngStyle]="element[field.column]?.style"
        >
          {{ element[field.column].value }}
        </div>
      </td>
    </ng-container>

    <ng-container *ngIf="field.column.match('InputDate$')">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style">{{ field.name | translate }}</th>
      <td mat-cell *matCellDef="let element; let i = dataIndex" (keyup)="onInputDateEnter($event, i)" (click)="$event.stopPropagation()">
        <imo-date-picker
          [default]="element.date"
          [labels]="element.datePlaceHolder"
          [filterDate]="element.dateLimitFn"
          (selectedDate)="element.callbackFn(i, $event)"
        ></imo-date-picker>
      </td>
    </ng-container>

    <ng-container *ngIf="!!field.modalRef">
      <th mat-header-cell *matHeaderCellDef [ngStyle]="field.style" class="open-modal-header-label">
        <span
          imoModal
          [modalId]="field.modalRef.id"
          [buttons]="field.modalRef.buttons"
          [title]="field.modalRef.title"
          [headerRef]="field.modalRef.headerRef"
          [templateRef]="field.modalRef.templateRef"
          [panelClass]="field.modalRef.panelClass"
          [isDisabledDragDrop]="field.modalRef.isDisabledDragDrop"
          [disableClose]="field.modalRef.disableClose"
        >
          {{ field.name | translate }}
          <imo-svg-icon [color]="'blue'" [icon]="openInNewIcon" alt="open-in-new-icon"></imo-svg-icon>
        </span>
      </th>
    </ng-container>

    <th
      mat-header-cell
      *matHeaderCellDef
      [ngStyle]="field.style"
      (click)="onClickSort((sortParamColumns && sortParamColumns[col]) || false)"
      [ngClass]="{ sortable: isSorting, 'sorted-column': sortParamColumns[col] == columnSelect && isSorting }"
    >
      <ng-container *ngIf="isSorting; else tableHeader">
        <span><ng-container [ngTemplateOutlet]="tableHeader"></ng-container></span>
      </ng-container>
      <ng-template #tableHeader>
        {{ field.sortAlignLeft ? "" : (field.name | translate) }}
        <imo-svg-icon
          [url]="sortIconByCol(sortParamColumns[col])"
          alt="sort-icon"
          *ngIf="checkColumnHasSorting(sortParamColumns[col]) && isSorting"
          [color]="sortParamColumns[col] == columnSelect && isSorting ? 'blue' : 'grey'"
        ></imo-svg-icon>
        {{ field.sortAlignLeft ? (field.name | translate) : "" }}
      </ng-template>
    </th>

    <ng-container *ngIf="field.column.match('IconField$')">
      <td mat-cell *matCellDef="let row; let i = dataIndex" [ngStyle]="field.style">
        <div fxLayout="row nowrap" fxLayoutAlign="start center" fxLayoutGap="0.2rem" class="icon-field">
          <div class="icon-list" *ngIf="row[field.column]?.icons">
            <span *ngFor="let icon of row[field.column]?.icons">
              <imo-svg-icon [width]="20" [height]="20" [icon]="icon" [alt]="icon"></imo-svg-icon>
            </span>
          </div>
          <div *ngIf="row[field.column]?.message">
            <ng-container *ngIf="isArrayValue(row[field.column]?.message); else defaultTemplate">
              <div *ngFor="let item of row[field.column]?.message" style="display: flex; justify-content: flex-end">
                <div
                  #blockElement
                  [matTooltip]="item | translate"
                  (mouseover)="isTextOverflow(blockElement, i)"
                  [matTooltipDisabled]="!tooltips[i]"
                  [innerHTML]="item"
                >
                  {{ item | translate }}
                </div>
              </div>
            </ng-container>
            <ng-template #defaultTemplate>
              <span>{{ row[field.column]?.message | translate }}</span>
            </ng-template>
          </div>
        </div>
      </td>
    </ng-container>

    <td mat-cell *matCellDef="let element; let i = dataIndex" [ngStyle]="field.style">
      <ng-container
        *ngIf="element[field.column]?.dynamicCreateComponent"
        svDynamicCreateComponent
        [componentData]="element[field.column]?.componentData"
      ></ng-container>

      <ng-container *ngIf="!element[field.column]?.dynamicCreateComponent">
        <ng-container *ngIf="isArrayValue(element[field.column]); else defaultTemplate">
          <div *ngFor="let item of element[field.column]">
            <div
              #blockElement
              [matTooltip]="item?.tooltip ?? (item | translate)"
              (mouseover)="isTextOverflow(blockElement, i)"
              [matTooltipDisabled]="!item?.tooltip ?? !tooltips[i]"
              matTooltipClass="large-tooltip"
              [innerHTML]="item?.html ?? (item | translate)"
            ></div>
          </div>
        </ng-container>
        <ng-template #defaultTemplate>
          <div
            #blockElement
            [matTooltip]="element[field.column] | translate"
            (mouseover)="isTextOverflow(blockElement, i)"
            [matTooltipDisabled]="!tooltips[i]"
            matTooltipClass="large-tooltip"
            [innerHTML]="element[field.column] | translate"
          ></div>
        </ng-template>
        <small
          *ngIf="element[field.column + 'SubText']"
          class="sub-rich-text"
          #blockElement
          [matTooltip]="element[field.column + 'SubText'] | translate"
          (mouseover)="isTextOverflow(blockElement, i)"
          [matTooltipDisabled]="!tooltips[i]"
          matTooltipClass="large-tooltip"
          [innerHTML]="element[field.column + 'SubText'] | translate"
        ></small>
        <div *ngIf="element[field.column + 'MultipleText']">{{ element[field.column + "MultipleText"] | translate }}</div>

        <small
          class="sub-rich-text"
          *ngIf="element[field.column + 'SubRichText']"
          #blockElement
          [matTooltip]="removeTag(element[field.column + 'SubRichText'] | translate)"
          (mouseover)="isTextOverflow(blockElement, i)"
          [matTooltipDisabled]="!tooltips[i]"
          [innerHTML]="element[field.column + 'SubRichText']"
          matTooltipClass="large-tooltip"
        ></small>
      </ng-container>
    </td>

    <ng-container *ngIf="!!footerData">
      <td mat-footer-cell *matFooterCellDef [ngStyle]="field.style">
        {{ footerData[field.column] | translate }}
      </td>
    </ng-container>

    <!-- Footer -->
    <ng-container *matFooterCellDef>
      <ng-container *ngIf="totalValue">
        <td *ngIf="col === 0" mat-footer-cell [colSpan]="displayedFields.length - 1" [ngStyle]="field.style" class="lable-group">
          {{ totalBy }}
        </td>
        <td *ngIf="col === displayedFields.length - 1" mat-footer-cell [ngStyle]="field.style" class="value-group">
          <div>{{ totalValue }}</div>
        </td>
      </ng-container>
    </ng-container>
    <!-- End of footer -->
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns" [hidden]="headless" [class.expansion-element-header]="expansionField"></tr>
  <ng-container *ngIf="!!footerData">
    <tr mat-header-row *matFooterRowDef="displayedColumns"></tr>
  </ng-container>

  <ng-container *ngIf="expansionField">
    <ng-container matColumnDef="expandedDetail">
      <td
        mat-cell
        *matCellDef="let element; let i = dataIndex"
        [attr.colspan]="displayedColumns.length"
        [class.nonexpendable]="element[expansionField] === undefined || element[expansionField] === null"
      >
        <div
          [class.expansion-element-detail]="element[expansionField]"
          *ngIf="element[expansionField]"
          [@detailExpand]="expandedElements[i] ? 'expanded' : 'collapsed'"
        >
          <ng-container *ngTemplateOutlet="expansionTmplRef; context: { $implicit: element, index: i }"></ng-container>
        </div>
      </td>
    </ng-container>
    <tr
      mat-row
      *matRowDef="let element; let i = dataIndex; columns: displayedColumns"
      [class.expansion-element-row]="element[expansionField]"
      [class.expansion-expendable]="element[expansionField] && element[expansionField].length"
      [class.expansion-expendable-disabled]="element[expansionField] && !element.expandable"
      [class.expansion-expanded-row]="element[expansionField] && expandedElements[i]"
      [class.no-expansion]="!element[expansionField]"
      (click)="toggleRow(i, $event)"
    ></tr>
    <tr
      mat-row
      *matRowDef="let row; let i = dataIndex; columns: ['expandedDetail']"
      class="expansion-detail-row"
      [class.expanded-row]="expandedElements[i]"
    ></tr>
  </ng-container>

  <ng-container *ngIf="!expansionField">
    <tr
      mat-row
      *matRowDef="let row; let i = dataIndex; columns: displayedColumns"
      (click)="!rowSelectable || getRecord(row); selectedIndex = i"
      [class.body-currency-total]="groupRows && groupRows.length > 0"
    ></tr>
  </ng-container>

  <!-- Row group -->
  <ng-container matColumnDef="labelTotalGroup">
    <th mat-header-cell *matHeaderCellDef [colSpan]="displayedFields.length - 1">labelTotalGroup</th>
    <td mat-cell *matCellDef="let element; let i = dataIndex" [colSpan]="displayedFields.length - 1" class="lable-group">
      {{ getLabelGroupRows(i + 1) }}
    </td>
  </ng-container>

  <ng-container matColumnDef="valueTotalGroup">
    <th mat-header-cell *matHeaderCellDef>valueTotalGroup</th>
    <td mat-cell *matCellDef="let element; let i = dataIndex">
      {{ getValueGroupRows(i + 1) }}
    </td>
  </ng-container>
  <!-- End row group -->

  <ng-container *ngIf="totalValue">
    <tr [ngClass]="isNoDataMessage ? 'show-data-message' : 'no-data-found-message'" mat-footer-row *matFooterRowDef="displayedColumns"></tr>
  </ng-container>

  <ng-container *ngIf="groupRows && groupRows.length">
    <tr
      mat-row
      *matRowDef="let item; let i = dataIndex; columns: displayedGroupFooter"
      [hidden]="!isGroup(i + 1)"
      [class.footer-group]="isGroup(i + 1)"
    ></tr>
  </ng-container>

  <ng-container matColumnDef="pagination">
    <td mat-footer-cell *matFooterCellDef [colSpan]="displayedFields.length">
      <imo-paginator
        [currentPage]="currentPage"
        [pageSizeOptions]="pageSizeOptions"
        [pageSize]="pageSize"
        [totalRecords]="totalRecords"
        (selected)="onPageChanged.emit($event)"
      ></imo-paginator>
    </td>
  </ng-container>

  <ng-container *ngIf="currentPage">
    <tr class="paginator" mat-footer-row *matFooterRowDef="['pagination']"></tr>
  </ng-container>
</table>

<table *ngIf="isNoDataMessage" class="table-no-data">
  <tr *ngIf="!dataSource.data.length">
    <td [attr.colspan]="displayedColumns.length">
      <imo-svg-icon [ngClass]="'text-' + messageOptions.status" [icon]="statusWarning.icon" [text]="messageOptions.message"></imo-svg-icon>
    </td>
  </tr>
</table>
